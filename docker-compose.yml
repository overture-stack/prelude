services:
  setup:
    profiles: ["demo", "dev", "default"]
    image: alpine/curl:8.8.0
    container_name: setup
    ports:
      - "9204:9204"
    volumes:
      - ./apps/setup:/setup
      - ./apps/setup/volumes/health:/health
    environment:
      # Global Configuration
      PROFILE: ${PROFILE:-default}
      DEBUG: false
      # Index Configuration
      # Dynamic indices are configured with a count and indexed variables
      INDEX_COUNT: 1
      # OHCRN sample data index
      INDEX_0_NAME: demo-index
      INDEX_0_TEMPLATE_FILE: setup/configs/indexConfigs/demo-mapping.json
      INDEX_0_TEMPLATE_NAME: demo-index
      INDEX_0_ALIAS_NAME: demo_centric
      # Arranger Services Configuration
      # Dynamically configurable number of Arranger instances
      ARRANGER_COUNT: 1
      ARRANGER_0_URL: http://arranger-datatable1:5050
      # Add more ARRANGER_X_URL as needed, matching ARRANGER_COUNT
      # ARRANGER_X_URL: http://arranger-x:505X
      # Service Connections
      ELASTICSEARCH_USER: elastic
      ELASTICSEARCH_PASS: myelasticpassword
      ELASTICSEARCH_URL: http://elasticsearch:9200
      CUSTOM_UI_URL: http://custom-ui:80
    command: >
      sh -c '
        set -e
        echo "Profile is set to: $PROFILE"
        case "$PROFILE" in
          "demo")
            echo "Running demo deployment..."
            chmod +x setup/scripts/deployments/demo.sh
            setup/scripts/deployments/demo.sh
            ;;
          "dev")
            echo "Running dev deployment..."
            chmod +x setup/scripts/deployments/dev.sh
            setup/scripts/deployments/dev.sh
            ;;
          *)
            echo "Invalid profile specified."
            exit 1
            ;;
        esac
        exit 0
      '
    healthcheck:
      test: ["CMD", "test", "-f", "setup/volumes/health/setup_health"]
      interval: 5s
      timeout: 40s
      retries: 100
      start_period: 30s
    networks:
      - demo-network

  # --------------------------------------------------------------------------------------#
  # Conductor CLI - Data Upload Service                                                  #
  # --------------------------------------------------------------------------------------#
  # Pre-built Node.js container for running conductor CLI operations                     #
  # --------------------------------------------------------------------------------------#
  conductor-cli:
    profiles: ["demo", "dev", "default"]
    build:
      context: ./apps/conductor
      dockerfile: Dockerfile
    image: conductor-cli:1.0
    container_name: conductor-cli
    pull_policy: never
    volumes:
      - ./data:/data
    command: >
      sh -c '
        echo "Starting conductor CLI - data upload service"
        echo "Available files in /data: $(ls -la /data/ || echo none)"
        node dist/main.js esupload \
        -f /data/demodata.csv \
        -i demo-index \
        --es-host elasticsearch:9200 \
        --es-user elastic \
        --es-pass myelasticpassword \
      '
    depends_on:
      setup:
        condition: service_completed_successfully
    networks:
      - demo-network

  # --------------------------------------------------------------------------------------#
  # Elasticsearch                                                                          #
  # --------------------------------------------------------------------------------------#
  # Search and analytics engine for querying large datatables                             #
  # Documentation Link: https://www.elastic.co/guide/en/elasticsearch/reference/7.17/    #
  # --------------------------------------------------------------------------------------#
  elasticsearch:
    profiles: ["demo", "dev", "default"]
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.10
    container_name: elasticsearch
    platform: linux/amd64
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - cluster.name=elasticsearch-cluster
      - node.name=elasticsearch-node1
      - "ES_JAVA_OPTS=-Xms8g -Xmx8g"
      - bootstrap.memory_lock=true
      - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    deploy:
      resources:
        limits:
          cpus: "6"
          memory: 16G
        reservations:
          cpus: "2"
          memory: 8G
    volumes:
      - index-data:/usr/share/elasticsearch/data
    healthcheck:
      test:
        "curl --silent --fail localhost:9200/_cluster/health?wait_for_status=yellow&timeout=50s ||
        exit 1"
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 25s
    networks:
      - demo-network

  # --------------------------------------------------------------------------------------#
  # OpenSearch (COMMENTED OUT - Reserved for future Arranger support)                    #
  # --------------------------------------------------------------------------------------#
  # NOTE: Arranger does not currently support OpenSearch. This configuration is          #
  # preserved for when OpenSearch support is added to Arranger in the future.            #
  # To use OpenSearch instead of Elasticsearch:                                           #
  #   1. Uncomment this service                                                           #
  #   2. Comment out the elasticsearch service above                                      #
  #   3. Update arranger-datatable1 ES_HOST to point to OpenSearch                       #
  #   4. Update setup environment variables to use OPENSEARCH_* instead of ELASTICSEARCH_*#
  #   5. Update deployment script to use opensearch scripts                              #
  # --------------------------------------------------------------------------------------#
  # opensearch:
  #   profiles: ["demo", "default"]
  #   image: opensearchproject/opensearch:2.11.1
  #   container_name: opensearch
  #   platform: linux/amd64
  #   ports:
  #     - "9200:9200"
  #     - "9600:9600"
  #   environment:
  #     PUID: 3381
  #     PGID: 100
  #     discovery.type: single-node
  #     cluster.name: opensearch-cluster
  #     node.name: opensearch-node1
  #     OPENSEARCH_JAVA_OPTS: -Xms8g -Xmx8g
  #     bootstrap.memory_lock: "true"
  #     DISABLE_INSTALL_DEMO_CONFIG: "true"
  #     DISABLE_SECURITY_PLUGIN: "true"
  #   ulimits:
  #     memlock:
  #       soft: -1
  #       hard: -1
  #     nofile:
  #       soft: 65536
  #       hard: 65536
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: "6"
  #         memory: 16G
  #       reservations:
  #         cpus: "2"
  #         memory: 8G
  #   volumes:
  #     - index-data:/usr/share/opensearch/data
  #   healthcheck:
  #     test:
  #       "curl --silent --fail localhost:9200/_cluster/health?wait_for_status=yellow&timeout=50s ||
  #       exit 1"
  #     interval: 10s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 25s
  #   networks:
  #     - demo-network

  # ------------------------------------------------------------------------------------#
  # Arranger-Server for our tabular data                                                #
  # ------------------------------------------------------------------------------------#
  # Search API generation with compatible search UI components                          #
  # Documentation Link: https://docs.overture.bio/docs/core-software/Arranger/overview  #
  # ------------------------------------------------------------------------------------#
  arranger-datatable1:
    profiles: ["demo", "dev", "default"]
    image: ghcr.io/overture-stack/arranger-server:ce3be7ff
    container_name: arranger-datatable1
    platform: linux/amd64
    depends_on:
      setup:
        condition: service_healthy
    ports:
      - "5050:5050"
    volumes:
      - ./apps/setup/configs/arrangerConfigs:/app/modules/server/configs
    environment:
      # Elasticsearch Variables
      ES_HOST: http://elasticsearch:9200
      ES_ARRANGER_SET_INDEX: demo_arranger_set
      # Arranger Variables (Port required)
      PORT: 5050
      DEBUG: false
      ENABLE_LOGS: false
    networks:
      - demo-network

  # ------------------------------------------------------------------------------------#
  # Custom UI - React/Vite Frontend                                                     #
  # ------------------------------------------------------------------------------------#
  # Custom user interface for data exploration                                          #
  # ------------------------------------------------------------------------------------#
  custom-ui:
    profiles: ["demo", "default"]
    build:
      context: ./apps/custom-ui
      dockerfile: Dockerfile
      args:
        VITE_ARRANGER_API: http://localhost:5050
        VITE_DOCUMENT_TYPE: file
        VITE_INDEX_NAME: demo_centric
    container_name: custom-ui
    platform: linux/amd64
    depends_on:
      setup:
        condition: service_healthy
    ports:
      - "3000:80"
    networks:
      - demo-network

volumes:
  index-data:
networks:
  demo-network:
    driver: bridge
